<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Pellet">
  <title>Lista movimenti ‚Ä¢ Pellet</title>

  <!-- No-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root { --space:14px; }

    /* ===== Reset + layout di pagina (come index) ========================== */
    * { box-sizing: border-box; }
    html, body { width:100%; max-width:100%; overflow-x:hidden; margin:0; }
    body{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      padding: var(--space);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:#fff;
    }

    /* Contenitore centrale (facoltativo, per max larghezza su schermi grandi) */
    .container { width:100%; max-width:640px; margin:0 auto; }

    /* ===== Topbar con titolo centrato ==================================== */
    .topbar{
      display:grid;
      grid-template-columns:48px 1fr 48px;  /* sx / centro / dx (slot vuoti) */
      align-items:center;
      height:48px;
      margin-bottom:10px;
    }
    .title{
      grid-column:2;
      margin:0;
      text-align:center;
      font-size:22px;
      font-weight:700;
    }

    /* Riga filtro stagione (destra) */
    .season-row{
      display:flex;
      justify-content:flex-end;
      margin:8px 0 12px;
      /* separatore tra filtro e lista */
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 16px;
    }
    .sel{
      padding:8px 12px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
      font:inherit;
      line-height:1.2;
      cursor:pointer;
    }
    .sel:focus-visible{ outline:2px solid #2684ff; outline-offset:2px; }

    /* ===== Tabella (lasciata minimalista) ================================ */
    h2 { margin: 0 0 10px; }
    .muted { color:#666; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #eee; font-size:15px; }
    th { font-weight:600; }
    .right { text-align:right; }
    .loading { margin-top:10px; }
    .err { color:#b00020; margin-top:8px; }
    .summary { margin-top:10px; font-size:14px; }

    .badge { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #aaa; margin-left:8px; font-variant-numeric: tabular-nums; }

    /* ===== Bottoni ======================================================== */
    .btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:10px 14px;
      border:1px solid #ddd; border-radius:12px; background:#fff;
      text-decoration:none; color:inherit; cursor:pointer;
      font: inherit; line-height:1;
      appearance:none; -webkit-appearance:none;
    }
    .btn:hover{ background:#f7f7f7; }
    .btn:active{ transform:translateY(1px); }
    .btn:focus-visible{ outline:2px solid #2684ff; outline-offset:2px; }

    /* Barra azioni in basso (sopra la versione) */
    .actions-footer{
      display:flex; gap:10px; justify-content:center;
      margin-top:auto;               /* spinge in basso le azioni */
      padding-top:12px;
    }

    /* Versione centrata in fondo alla pagina */
    .version-footer{
      text-align:center;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      width:100%;
    }
  </style>
</head>
<body>

  <!-- HEADER: icona + label centrati -->
  <header class="topbar container">
    <h1 class="title">üìÑ Lista movimenti</h1>
  </header>

  <main class="container" role="main">
    <!-- Filtro stagione in alto a destra -->
    <div class="season-row">
      <select id="seasonFilter" class="sel" aria-label="Filtra per stagione" title="Filtra per stagione">
        <option value="">Tutte le stagioni</option>
      </select>
    </div>

    <div id="status" class="loading">Carico‚Ä¶</div>

    <table id="tbl" aria-live="polite" style="display:none;">
      <thead>
        <tr>
          <th>Data</th>
          <th class="right">Num. sacchi</th>
          <th class="right">Totale (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="summary" class="summary" style="display:none;"></div>
  </main>

  <!-- AZIONI: in basso sopra la versione -->
  <div class="actions-footer container">
    <a class="btn" id="backBtn" href="index.html" target="_self" aria-label="Torna all'inserimento">‚Üê Nuovo movimento</a>
    <button class="btn" id="refreshBtn" type="button" aria-label="Ricarica elenco">‚ü≥ Ricarica</button>
  </div>

  <!-- Versione in fondo e centrata -->
  <div class="version-footer muted">Versione: <span id="appVersion" class="badge"></span></div>

<script>
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwven5iCbDk8Fy0Vw7l7jQL2FHY1kTM05TlnAk8N3yE4-NfDjh052fPSbS7Vr4Qgf7l9A/exec';
const SECRET   = 'aX4P-92kLq-55T8b-7Hc0Z';

function formatVersionFromDate(d){const p=n=>String(n).padStart(2,'0');return`${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())}-${p(d.getHours())}:${p(d.getMinutes())}`;}
function computeAppVersion(){
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v');
  if (v) return v;
  const d = new Date(document.lastModified);
  return isNaN(d)?'dev':formatVersionFromDate(d);
}
document.getElementById('appVersion').textContent = computeAppVersion();

function euro(x){return Number(x).toFixed(2).replace('.', ',');}

let ALL_ROWS = [];
let FILTER = { stagione: '' };

function populateSeasons(stagioni) {
  const sel = document.getElementById('seasonFilter');
  sel.querySelectorAll('option:not([value=""])').forEach(o => o.remove());
  stagioni.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
}

function renderTable() {
  const tbl = document.getElementById('tbl');
  const tbody = tbl.querySelector('tbody');
  const status = document.getElementById('status');
  const summary = document.getElementById('summary');

  tbody.innerHTML = '';
  const rows = ALL_ROWS.filter(r => !FILTER.stagione || r.stagione === FILTER.stagione);

  if (rows.length === 0) {
    tbl.style.display = 'none';
    summary.style.display = 'none';
    status.textContent = 'Nessun movimento per il filtro selezionato.';
    status.className = 'muted';
    return;
  }

  let somma = 0, sacchi = 0;
  for (const r of rows) {
    const tr = document.createElement('tr');
    const tdData = document.createElement('td');
    const tdSacchi = document.createElement('td');
    const tdTotale = document.createElement('td');

    tdData.textContent = r.data;
    tdSacchi.textContent = r.num_sacchi;
    tdTotale.textContent = euro(r.totale);

    tdSacchi.className = 'right';
    tdTotale.className = 'right';

    tr.appendChild(tdData);
    tr.appendChild(tdSacchi);
    tr.appendChild(tdTotale);
    tbody.appendChild(tr);

    somma += Number(r.totale || 0);
    sacchi += Number(r.num_sacchi || 0);
  }

  status.textContent = '';
  tbl.style.display = 'table';
  summary.textContent = `Totale movimenti: ${rows.length} ‚Ä¢ Sacchi: ${sacchi} ‚Ä¢ Spesa: ‚Ç¨ ${euro(somma)}`;
  summary.style.display = 'block';
}

async function loadList() {
  const status = document.getElementById('status');
  status.textContent = 'Carico‚Ä¶';
  status.className = 'loading';

  try {
    const url = new URL(ENDPOINT);
    url.searchParams.set('action','list');
    url.searchParams.set('secret', SECRET);

    const res = await fetch(url.toString(), { method:'GET' });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);

    ALL_ROWS = json.rows || [];
    populateSeasons(json.stagioni || []);
    renderTable();
  } catch (err) {
    status.textContent = 'Errore nel caricamento. Sei offline o non autorizzato.';
    status.className = 'err';
  }
}

document.getElementById('refreshBtn').addEventListener('click', loadList);
document.getElementById('seasonFilter').addEventListener('change', e => {
  FILTER.stagione = e.target.value || '';
  renderTable();
});

document.addEventListener('DOMContentLoaded', loadList);
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const back = document.getElementById('backBtn');
  if (!back) return;

  back.addEventListener('click', (e) => {
    // Se lista.html √® aperta DENTRO l'iframe della index (overlay full-screen)
    if (window.top !== window.self) {
      e.preventDefault();
      window.top.postMessage('close-lista', '*'); // chiedi alla index di chiudere l‚Äôoverlay
      return;
    }
    // Se aperta stand-alone, il link naviga verso index.html normalmente
  });
});
</script>

</body>
</html>
