<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pellet</title>
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- No-cache per ridurre ambiguitÃ  tra versioni su GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root { --space:14px; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: var(--space);
    }
    h2 { margin: 0 0 10px; }
    label { display: block; margin: 12px 0 6px; font-size: 14px; }
    input, button {
      width: 100%; font-size: 16px; padding: 10px; box-sizing: border-box;
    }
    button {
      margin-top: 16px; border-radius: 10px; border: 1px solid #ddd;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer;
    }
    .ok { color: green; margin-top: 8px; }
    .err { color: #b00020; margin-top: 8px; }
    .muted { color: #666; font-size: 12px; margin-top: 6px; }
    .badge {
      display: inline-block; font-size: 12px; padding: 2px 8px;
      border-radius: 999px; border: 1px solid #aaa; margin-left: 8px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Loader overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    .loading-overlay[aria-hidden="false"] { display: flex; }
    .spinner {
      width: 38px; height: 38px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.7);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Spinner inline sul bottone â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.7);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    button[disabled] { opacity: 0.7; cursor: not-allowed; }

/* Topbar a 3 colonne: [hamburger][titolo centrato][spazio] */
.topbar{
  display:grid;
  grid-template-columns: 48px 1fr 48px; /* sinistra / centro / destra */
  align-items:center;
  height:48px;
  margin-bottom:14px;
}

.menu-btn{
  grid-column:1;                /* colonna sinistra */
  justify-self:start;
  background:none;
  border:none;
  font-size:22px;
  line-height:1;
  padding:8px 12px;
  cursor:pointer;
}

.title{
  grid-column:2;                /* colonna centrale */
  margin:0;
  text-align:center;            /* centrato rispetto alla pagina */
  font-size:22px;
}

.right-slot{
  grid-column:3;                /* colonna destra â€œvuotaâ€ per bilanciare */
}

  </style>
</head>

<body>

  <!-- â”€â”€â”€ Top bar con hamburger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="topbar">
  <button id="menuBtn" class="menu-btn" aria-label="Apri menu">â˜°</button>
  <h2 class="title">ğŸ”¥ Pellet</h2>
  <span class="right-slot" aria-hidden="true"></span>
</header>

<!-- Drawer semplice -->
<nav id="drawer" style="
  position:fixed;inset:0 35% 0 0;max-width:280px;background:#fff;border-right:1px solid #eee;
  transform:translateX(-105%);transition:transform .2s ease;z-index:9998;padding:16px;">
  <h3 style="margin-top:0;">Menu</h3>
  <ul style="list-style:none;padding:0;margin:0;">
    <li><a id="goLista" href="#">ğŸ“„ Lista movimenti</a></li>
  </ul>
</nav>
<div id="backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.15);display:none;z-index:9997;"></div>

  <script>
  // Drawer toggle
  (function(){
    const btn = document.getElementById('menuBtn');
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const open = () => { drawer.style.transform='translateX(0)'; backdrop.style.display='block'; };
    const close= () => { drawer.style.transform='translateX(-105%)'; backdrop.style.display='none'; };
    btn.addEventListener('click', open);
    backdrop.addEventListener('click', close);
  })();
</script>


  <script>
document.addEventListener('DOMContentLoaded', () => {
  const pad = n => String(n).padStart(2,'0');
  const d = new Date(document.lastModified);
  const vIndex = isNaN(d) ? 'dev'
    : `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}-${pad(d.getHours())}:${pad(d.getMinutes())}`;

  const urlLista = `lista.html?v=${encodeURIComponent(vIndex)}`;

  const linkLista = document.getElementById('goLista');
  const frame     = document.getElementById('pageFrame');
  const drawer    = document.getElementById('drawer');
  const backdrop  = document.getElementById('backdrop');

  function openFrame(url){
    // chiudi il drawer, mostra lâ€™iframe a schermo intero
    if (drawer)  drawer.style.transform = 'translateX(-105%)';
    if (backdrop) backdrop.style.display = 'none';

    frame.src = url;
    frame.style.display = 'block';

    // gestisci cronologia: Back chiude lâ€™iframe
    history.pushState({page:'lista'}, '', '#lista');
  }

  function closeFrame(){
    frame.style.display = 'none';
    frame.src = 'about:blank';
    if (location.hash === '#lista') history.back();
  }

  // intercetta click su â€œLista movimentiâ€
  if (linkLista) {
    linkLista.href = urlLista;              // fallback, se aperto in Safari normale
    linkLista.setAttribute('target','_self');
    linkLista.addEventListener('click', (e) => {
      e.preventDefault();
      openFrame(urlLista);                  // âœ… sempre full-screen, niente Safari
    });
  }

  // Back fisico (swipe indietro o â†) chiude lâ€™iframe
  window.addEventListener('popstate', () => {
    if (frame.style.display === 'block') {
      frame.style.display = 'none';
      frame.src = 'about:blank';
    }
  });

  // Consenti a lista.html di chiedere "chiudi" (vedi step 3)
  window.addEventListener('message', (ev) => {
    if (ev && ev.data === 'close-lista') closeFrame();
  });
});
</script>

  <label>Data</label>
  <input id="data" type="date" required>

  <label>Numero sacchi</label>
  <input id="numSacchi" type="number" inputmode="numeric" step="1" min="1" placeholder="es. 5" required>

  <label>Prezzo (â‚¬/sacco)</label>
  <!-- pattern: max 2 decimali, accetta virgola o punto -->
  <input id="prezzo" type="text" inputmode="numeric" pattern="\\d+(?:[\\.,]\\d{1,2})?" placeholder="es. 5,90" required>

  <label>Totale (â‚¬)</label>
  <input id="totale" type="text" inputmode="numeric" pattern="\\d+(?:[\\.,]\\d{1,2})?" placeholder="es. 35,40" required>

  <button id="saveBtn">
    <span class="btn-text">Salva</span>
  </button>
  <div id="msg" role="status" aria-live="polite"></div>

  <!-- Versione app -->
  <div class="muted">Versione: <span id="appVersion" class="badge"></span></div>

  <!-- Overlay globale -->
  <div id="loaderOverlay" class="loading-overlay" aria-hidden="true" aria-live="polite" aria-busy="false">
    <div class="spinner" role="progressbar" aria-label="Salvataggio in corso"></div>
  </div>

<script>
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwven5iCbDk8Fy0Vw7l7jQL2FHY1kTM05TlnAk8N3yE4-NfDjh052fPSbS7Vr4Qgf7l9A/exec';
const SECRET   = 'aX4P-92kLq-55T8b-7Hc0Z';

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   VERSIONING                  *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function formatVersionFromDate(d) {
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}-${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function computeAppVersion() {
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v');
  if (v) return v;                            // override manuale: ?v=YYYY.MM.DD-HH:MM
  const d = new Date(document.lastModified);  // timestamp del file servito
  if (!isNaN(d)) return formatVersionFromDate(d);
  return 'dev';
}
function showAppVersion() {
  const el = document.getElementById('appVersion');
  if (el) el.textContent = computeAppVersion();
  console.log('[App] Versione:', computeAppVersion());
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   DATA ODIERNA DI DEFAULT     *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function initDate(){
  const d = new Date();
  const pad = n => String(n).padStart(2, '0');
  document.getElementById('data').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   LOADER UTILS                *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const saveBtn = document.getElementById('saveBtn');
const btnText = saveBtn.querySelector('.btn-text');
const loaderOverlay = document.getElementById('loaderOverlay');

function setLoading(isLoading) {
  loaderOverlay.setAttribute('aria-hidden', String(!isLoading));
  loaderOverlay.setAttribute('aria-busy', String(isLoading));

  saveBtn.disabled = isLoading;
  saveBtn.setAttribute('aria-busy', String(isLoading));
  if (isLoading) {
    if (!saveBtn.querySelector('.btn-spinner')) {
      const s = document.createElement('span');
      s.className = 'btn-spinner';
      s.setAttribute('aria-hidden', 'true');
      saveBtn.prepend(s);
    }
    btnText.textContent = 'Salvoâ€¦';
  } else {
    const s = saveBtn.querySelector('.btn-spinner');
    if (s) s.remove();
    btnText.textContent = 'Salva';
  }

  const controls = document.querySelectorAll('input, button');
  controls.forEach(el => { if (el !== saveBtn) el.disabled = isLoading; });
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   FORMATTATORI / VALIDAZIONI  *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let userEditedTotal = false;
let settingTotalProgrammatically = false;

function toMoneyDisplayFromNumber(n) {
  // n Ã¨ Number; ritorna stringa con virgola e due decimali
  return Number(n).toFixed(2).replace('.', ',');
}

function recomputeTotalIfNeeded() {
  const totEl = document.getElementById('totale');
  if (userEditedTotal && totEl.value.trim() !== '') return;

  const numSacchiRaw = document.getElementById('numSacchi').value;
  const prezzoRaw    = document.getElementById('prezzo').value;

  if (!/^\d+$/.test(String(numSacchiRaw)) || Number(numSacchiRaw) <= 0) return;

  const prezzoNorm = parseMoneySmart(prezzoRaw); // gestisce anche il display con virgola
  if (prezzoNorm === null) return;

  const totaleNum  = Number(numSacchiRaw) * Number(prezzoNorm);
  const totDisplay = totaleNum.toFixed(2).replace('.', ',');

  settingTotalProgrammatically = true;
  totEl.value = totDisplay;
  settingTotalProgrammatically = false;
}

// Converte "cifre" (centesimi) in testo con virgola: "590" -> "5,90"
function formatPosDisplayFromDigits(digits) {
  if (!digits) return '';
  // rimuovi zeri a sinistra ma lascia almeno "0"
  digits = digits.replace(/^0+/, '') || '0';

  if (digits.length === 1) return `0,0${digits}`;
  if (digits.length === 2) return `0,${digits}`;
  const intPart = digits.slice(0, -2);
  const decPart = digits.slice(-2);
  // separatore delle migliaia opzionale (non necessario su mobile)
  return `${intPart},${decPart}`;
}

// Ritorna un numero normalizzato con PUNTO e 2 decimali da sole cifre: "590" -> "5.90"
function normalizedFromDigits(digits) {
  if (!/^\d+$/.test(digits)) return null;
  return (Number(digits) / 100).toFixed(2); // "5.90"
}
  
// Parser â€œsmartâ€: accetta solo cifre (POS) o formati classici con virgola/punto
function parseMoneySmart(value) {
  const raw = String(value || '').trim();
  if (raw === '') return null;

  // Solo cifre â†’ interpretazione come centesimi
  if (/^\d+$/.test(raw)) return normalizedFromDigits(raw);

  // Formati classici con virgola/punto (max 2 decimali)
  const s = raw.replace(',', '.');
  if (!/^\d+(\.\d{1,2})?$/.test(s)) return null;
  return Number(s).toFixed(2);
}

// Gestore "live POS": mantiene solo cifre, aggiorna display con virgola ad ogni input
function attachPosMoney(el, { onChange } = {}) {
  el.addEventListener('input', () => {
    // prendi solo cifre dallâ€™input
    const digits = (el.value || '').replace(/\D/g, '');
    // trasforma in display con virgola
    const display = formatPosDisplayFromDigits(digits);
    const selectionToEnd = document.activeElement === el;

    // aggiorna il campo (mostra la virgola mentre si digita)
    const prevLen = el.value.length;
    el.value = display;

    // metti il cursore alla fine (comportamento tipico POS su mobile)
    if (selectionToEnd) {
      try { el.setSelectionRange(el.value.length, el.value.length); } catch {}
    }

    // callback con valore normalizzato "5.90" (o null se vuoto)
    if (typeof onChange === 'function') {
      onChange(digits ? normalizedFromDigits(digits) : null);
    }
  });
}

function onBlurMoneyInput(ev) {
  const norm = parseMoneySmart(ev.target.value);
  if (norm !== null) {
    // Visualizza con virgola
    ev.target.value = norm.replace('.', ',');
  }
}

function isPositiveInteger(str) {
  return /^\d+$/.test(String(str)) && Number(str) > 0;
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   INVIO FORM                  *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function sendForm(data) {
  const params = new URLSearchParams(data);
  const res = await fetch(ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
    body: params.toString(),
  });
  return res.json();
}

async function onSaveClick() {
  const msg = document.getElementById('msg');
  msg.textContent = '';
  msg.className = '';

  const data        = document.getElementById('data').value;
  const numSacchiRaw= document.getElementById('numSacchi').value;
  const prezzoRaw   = document.getElementById('prezzo').value;
  const totaleRaw   = document.getElementById('totale').value;

  if (!data){ msg.textContent='Inserisci la data.'; msg.className='err'; return; }
  if (!/^\d+$/.test(String(numSacchiRaw)) || Number(numSacchiRaw) <= 0){
    msg.textContent='Numero sacchi non valido (intero > 0).'; msg.className='err'; return;
  }

  const prezzoNorm = parseMoneySmart(document.getElementById('prezzo').value);
  if (prezzoNorm === null){ msg.textContent='Prezzo non valido.'; msg.className='err'; return; }

  const totaleNorm = parseMoneySmart(document.getElementById('totale').value);
  if (totaleNorm === null){ msg.textContent='Totale non valido.'; msg.className='err'; return; }

  const payload = {
    secret: SECRET,
    data,
    num_sacchi: numSacchiRaw,
    prezzo: prezzoNorm, // con punto e 2 decimali
    totale: totaleNorm  // con punto e 2 decimali
  };

  try {
    setLoading(true);
    const out = await sendForm(payload);
    if (out.ok) {
      msg.textContent = 'Salvato âœ…';
      msg.className = 'ok';
      document.getElementById('numSacchi').value='';
      document.getElementById('prezzo').value='';
      document.getElementById('totale').value='';
    } else {
      msg.textContent = out.error ? `Errore: ${out.error}` : 'Errore di rete o autorizzazione.';
      msg.className = 'err';
    }
  } catch {
    msg.textContent='Sei offline. Dato non inviato.';
    msg.className='err';
  } finally {
    setLoading(false);
  }
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   BOOT                        *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.addEventListener('DOMContentLoaded', () => {
  showAppVersion();
  initDate();

  const saveBtn  = document.getElementById('saveBtn');
  const numEl    = document.getElementById('numSacchi');
  const prezzoEl = document.getElementById('prezzo');
  const totEl    = document.getElementById('totale');

  // Salvataggio
  saveBtn.addEventListener('click', onSaveClick);

  // Formattazione "live POS" su PREZZO e TOTALE
  attachPosMoney(prezzoEl, {
    onChange: () => {
      // ogni cambiamento del prezzo prova a ricalcolare
      recomputeTotalIfNeeded();
    }
  });

  attachPosMoney(totEl, {
    onChange: (norm) => {
      // se lâ€™utente digita nel TOTALE, blocca lâ€™autocalcolo; se lo svuota, riattivalo
      if (settingTotalProgrammatically) return;
      const hasValue = norm !== null;
      userEditedTotal = hasValue;
      if (!hasValue) recomputeTotalIfNeeded();
    }
  });

  // Lâ€™autocalcolo scatta anche al cambio del numero sacchi
  numEl.addEventListener('input', recomputeTotalIfNeeded);

  // Primo tentativo di calcolo (se i campi sono giÃ  valorizzati)
  recomputeTotalIfNeeded();
});

</script>

<!-- Overlay pagina secondaria -->
<iframe id="pageFrame" style="
  position:fixed; inset:0; width:100vw; height:100vh; border:0;
  display:none; background:#fff; z-index:9999;
"></iframe>

  <script>addEventListener('pageshow', e => e.persisted && location.reload());</script>

  
</body>
</html>














