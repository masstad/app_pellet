<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pellet</title>
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- No-cache per ridurre ambiguitÃ  tra versioni su GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root { --space:14px; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: var(--space);
    }
    h2 { margin: 0 0 10px; }
    label { display: block; margin: 12px 0 6px; font-size: 14px; }
    input, button {
      width: 100%; font-size: 16px; padding: 10px; box-sizing: border-box;
    }
    button {
      margin-top: 16px; border-radius: 10px; border: 1px solid #ddd;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer;
    }
    .ok { color: green; margin-top: 8px; }
    .err { color: #b00020; margin-top: 8px; }
    .muted { color: #666; font-size: 12px; margin-top: 6px; }
    .badge {
      display: inline-block; font-size: 12px; padding: 2px 8px;
      border-radius: 999px; border: 1px solid #aaa; margin-left: 8px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Loader overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    .loading-overlay[aria-hidden="false"] { display: flex; }
    .spinner {
      width: 38px; height: 38px;
      border: 3px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.7);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Spinner inline sul bottone â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.7);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    button[disabled] { opacity: 0.7; cursor: not-allowed; }
  </style>
</head>

<body>
  <h2>ðŸ”¥ Pellet</h2>

  <label>Data</label>
  <input id="data" type="date" required>

  <label>Numero sacchi</label>
  <input id="numSacchi" type="number" inputmode="numeric" step="1" min="1" placeholder="es. 5" required>

  <label>Prezzo (â‚¬/sacco)</label>
  <!-- pattern: max 2 decimali, accetta virgola o punto -->
  <input id="prezzo" type="text" inputmode="decimal" pattern="\\d+(?:[\\.,]\\d{1,2})?" placeholder="es. 5,90" required>

  <label>Totale (â‚¬)</label>
  <input id="totale" type="text" inputmode="decimal" pattern="\\d+(?:[\\.,]\\d{1,2})?" placeholder="es. 35,40" required>

  <button id="saveBtn">
    <span class="btn-text">Salva</span>
  </button>
  <div id="msg" role="status" aria-live="polite"></div>

  <!-- Versione app -->
  <div class="muted">Versione: <span id="appVersion" class="badge"></span></div>

  <!-- Overlay globale -->
  <div id="loaderOverlay" class="loading-overlay" aria-hidden="true" aria-live="polite" aria-busy="false">
    <div class="spinner" role="progressbar" aria-label="Salvataggio in corso"></div>
  </div>

<script>
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwven5iCbDk8Fy0Vw7l7jQL2FHY1kTM05TlnAk8N3yE4-NfDjh052fPSbS7Vr4Qgf7l9A/exec';
const SECRET   = 'aX4P-92kLq-55T8b-7Hc0Z';

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   VERSIONING                  *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function formatVersionFromDate(d) {
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}-${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function computeAppVersion() {
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v');
  if (v) return v;                            // override manuale: ?v=YYYY.MM.DD-HH:MM
  const d = new Date(document.lastModified);  // timestamp del file servito
  if (!isNaN(d)) return formatVersionFromDate(d);
  return 'dev';
}
function showAppVersion() {
  const el = document.getElementById('appVersion');
  if (el) el.textContent = computeAppVersion();
  console.log('[App] Versione:', computeAppVersion());
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   DATA ODIERNA DI DEFAULT     *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function initDate(){
  const d = new Date();
  const pad = n => String(n).padStart(2, '0');
  document.getElementById('data').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   LOADER UTILS                *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const saveBtn = document.getElementById('saveBtn');
const btnText = saveBtn.querySelector('.btn-text');
const loaderOverlay = document.getElementById('loaderOverlay');

function setLoading(isLoading) {
  loaderOverlay.setAttribute('aria-hidden', String(!isLoading));
  loaderOverlay.setAttribute('aria-busy', String(isLoading));

  saveBtn.disabled = isLoading;
  saveBtn.setAttribute('aria-busy', String(isLoading));
  if (isLoading) {
    if (!saveBtn.querySelector('.btn-spinner')) {
      const s = document.createElement('span');
      s.className = 'btn-spinner';
      s.setAttribute('aria-hidden', 'true');
      saveBtn.prepend(s);
    }
    btnText.textContent = 'Salvoâ€¦';
  } else {
    const s = saveBtn.querySelector('.btn-spinner');
    if (s) s.remove();
    btnText.textContent = 'Salva';
  }

  const controls = document.querySelectorAll('input, button');
  controls.forEach(el => { if (el !== saveBtn) el.disabled = isLoading; });
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   FORMATTATORI / VALIDAZIONI  *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function sanitizeMoney(value) {
  // accetta "12", "12.3", "12,34" â†’ ritorna stringa con '.' come separatore
  const s = String(value || '').trim().replace(',', '.');
  if (!/^\d+(\.\d{1,2})?$/.test(s)) return null; // max 2 decimali
  return Number(s).toFixed(2); // normalizza a due decimali
}

function onBlurMoneyInput(ev) {
  const norm = sanitizeMoney(ev.target.value);
  if (norm !== null) ev.target.value = norm.replace('.', ','); // mostra con virgola
}

function isPositiveInteger(str) {
  return /^\d+$/.test(String(str)) && Number(str) > 0;
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   INVIO FORM                  *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function sendForm(data) {
  const params = new URLSearchParams(data);
  const res = await fetch(ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
    body: params.toString(),
  });
  return res.json();
}

async function onSaveClick() {
  const msg = document.getElementById('msg');
  msg.textContent = '';
  msg.className = '';

  const data = document.getElementById('data').value;
  const numSacchiRaw = document.getElementById('numSacchi').value;
  const prezzoRaw = document.getElementById('prezzo').value;
  const totaleRaw = document.getElementById('totale').value;

  if (!data){ msg.textContent='Inserisci la data.'; msg.className='err'; return; }
  if (!isPositiveInteger(numSacchiRaw)){ msg.textContent='Numero sacchi non valido (intero > 0).'; msg.className='err'; return; }

  const prezzoNorm = sanitizeMoney(prezzoRaw);
  if (prezzoNorm === null){ msg.textContent='Prezzo non valido (max 2 decimali).'; msg.className='err'; return; }

  const totaleNorm = sanitizeMoney(totaleRaw);
  if (totaleNorm === null){ msg.textContent='Totale non valido (max 2 decimali).'; msg.className='err'; return; }

  const payload = {
    secret: SECRET,
    data,
    num_sacchi: numSacchiRaw,
    prezzo: prezzoNorm, // con punto
    totale: totaleNorm  // con punto
  };

  try {
    setLoading(true);
    const out = await sendForm(payload);
    if (out.ok) {
      msg.textContent = 'Salvato âœ…';
      msg.className = 'ok';
      document.getElementById('numSacchi').value='';
      document.getElementById('prezzo').value='';
      document.getElementById('totale').value='';
    } else {
      msg.textContent = out.error ? `Errore: ${out.error}` : 'Errore di rete o autorizzazione.';
      msg.className = 'err';
    }
  } catch {
    msg.textContent='Sei offline. Dato non inviato.';
    msg.className='err';
  } finally {
    setLoading(false);
  }
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*
 *   BOOT                        *
 *â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.addEventListener('DOMContentLoaded', () => {
  showAppVersion();
  initDate();
  document.getElementById('saveBtn').addEventListener('click', onSaveClick);

  // normalizza visualmente i campi monetari a due decimali all'uscita dal campo
  document.getElementById('prezzo').addEventListener('blur', onBlurMoneyInput);
  document.getElementById('totale').addEventListener('blur', onBlurMoneyInput);
});
</script>
</body>
</html>
